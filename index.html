<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <title>Tip Split</title>

  <style>
    :root{
      --bg:#070a12;
      --panel:#0b0f1a;
      --card:#0f1526;
      --line:rgba(255,255,255,.08);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.68);
      --brand:#3b82f6;
      --good:#22c55e;
      --bad:#fb7185;
      --tap:50px;
      --r:18px;
      --shadow: 0 12px 34px rgba(0,0,0,.45);
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(59,130,246,.25), transparent 55%),
        radial-gradient(900px 600px at 120% 0%, rgba(34,197,94,.16), transparent 60%),
        linear-gradient(180deg, var(--bg), #05070d 60%, #04060b);
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:20;
      padding:14px 16px 10px;
      background: rgba(7,10,18,.72);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--line);
    }
    .titleRow{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      max-width:980px; margin:0 auto;
    }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .tiny{ color:var(--muted); font-size:12px; line-height:1.2; text-align:right; }

    .wrap{ max-width:980px; margin:0 auto; padding:16px; }

    .shell{
      border:1px solid var(--line);
      background: rgba(11,15,26,.72);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .gridTop{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr 1.1fr 1.1fr .9fr;
      gap:10px;
    }

    @media (max-width:860px){
      .gridTop{ grid-template-columns: 1fr 1fr; }
      .tiny{ text-align:left; }
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select{
      width:100%;
      height:var(--tap);
      padding:0 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(15,21,38,.9);
      color: var(--text);
      outline:none;
      font-size:16px;
    }
    input::placeholder{ color:rgba(238,242,255,.35); }
    input:focus, select:focus{
      border-color: rgba(59,130,246,.75);
      box-shadow: 0 0 0 3px rgba(59,130,246,.18);
    }

    .btnRow{
      padding:0 14px 14px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    button{
      height:var(--tap);
      padding:0 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(15,21,38,.9);
      color:var(--text);
      font-size:15px;
      font-weight:700;
      cursor:pointer;
      flex:1;
      min-width:150px;
      transition: filter .12s ease, transform .03s ease;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(59,130,246,.7));
      border-color: rgba(59,130,246,.75);
    }
    button.ghost{
      background: rgba(15,21,38,.7);
    }
    button.danger{
      background: rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.22);
      color: rgba(255,225,231,.95);
    }
    button:active{ transform: scale(.99); }
    button:hover{ filter: brightness(1.06); }

    .table{
      border-top:1px solid var(--line);
    }
    .thead, .trow{
      display:grid;
      grid-template-columns: 1.35fr .65fr .7fr;
      gap:10px;
      padding:12px 14px;
      align-items:center;
    }
    .thead{
      color: var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.02);
      border-bottom:1px solid var(--line);
    }
    .trow{
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .trow:last-child{ border-bottom:none; }

    .nameCell{ display:flex; gap:10px; align-items:center; min-width:0; }
    .miniBtn{
      width:42px; height:42px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(7,10,18,.6);
      color: rgba(238,242,255,.85);
      font-size:18px;
      line-height:1;
      flex:0 0 auto;
    }

    .payPill{
      height:42px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(7,10,18,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:.2px;
      font-variant-numeric: tabular-nums;
    }
    .payPill.ready{
      border-color: rgba(34,197,94,.28);
      box-shadow: 0 0 0 3px rgba(34,197,94,.08);
    }

    .summary{
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding:14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .box{
      border:1px solid var(--line);
      background: rgba(15,21,38,.75);
      border-radius: 16px;
      padding:12px;
      min-height:74px;
    }
    .box .k{ color:var(--muted); font-size:12px; margin-bottom:6px; }
    .box .v{
      font-size:18px;
      font-weight:900;
      font-variant-numeric: tabular-nums;
    }
    .ok{ color:var(--good); font-weight:900; }
    .no{ color:var(--bad); font-weight:900; }

    @media (max-width:860px){
      .summary{ grid-template-columns: 1fr 1fr; }
      .thead,.trow{ grid-template-columns: 1.25fr .75fr .8fr; }
    }

    .foot{
      padding:14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .kbd{
      display:inline-block;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(7,10,18,.45);
      color: rgba(238,242,255,.85);
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>

<body>
<header>
  <div class="titleRow">
    <div>
      <h1>Tip Split</h1>
      <div class="tiny">Whole dollars only • iPhone-friendly • Works offline</div>
    </div>
    <div class="tiny">
      Extra rule: <span class="kbd">Top Hours</span><br/>
      Ties split evenly, leftover $1s random
    </div>
  </div>
</header>

<div class="wrap">
  <div class="shell">
    <div class="gridTop">
      <div>
        <label>Total Tips ($)</label>
        <input id="totalTips" inputmode="numeric" pattern="[0-9]*" placeholder="270" />
      </div>

      <div>
        <label>Quick Add Name (autocomplete)</label>
        <input id="quickName" list="nameSuggestions" placeholder="Start typing…" />
        <datalist id="nameSuggestions"></datalist>
      </div>

      <div>
        <label>Hours</label>
        <input id="quickHours" inputmode="decimal" placeholder="8.5" />
      </div>

      <div>
        <label>Extra Money Option</label>
        <select id="extraMode">
          <option value="none">Do nothing</option>
          <option value="random">Random</option>
          <option value="tophours" selected>Top Hours (split ties)</option>
        </select>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="calcBtn">Calculate</button>
      <button class="ghost" id="addBtn">Add Person</button>
      <button class="danger" id="resetBtn">Reset</button>
    </div>

    <div class="table">
      <div class="thead">
        <div>Name</div>
        <div>Hours</div>
        <div>Final Pay</div>
      </div>
      <div id="rows"></div>
    </div>

    <div class="summary">
      <div class="box">
        <div class="k">Total Hours</div>
        <div class="v" id="sumHours">0</div>
      </div>
      <div class="box">
        <div class="k">Rate ($/hr)</div>
        <div class="v" id="rate">$0.00</div>
      </div>
      <div class="box">
        <div class="k">Sum of Payouts</div>
        <div class="v" id="sumPay">$0</div>
      </div>
      <div class="box">
        <div class="k">Unassigned (if “Do nothing”)</div>
        <div class="v" id="unassigned">$0</div>
      </div>
      <div class="box" style="grid-column:1/-1;">
        <div class="k">Status</div>
        <div class="v" id="status"><span class="no">Waiting</span></div>
      </div>
    </div>

    <div class="foot">
      Quick Add: type name → <span class="kbd">Enter</span> → type hours → <span class="kbd">Enter</span>. New names auto-save.
      Recalculate reshuffles random tie-breaks when needed.
    </div>
  </div>
</div>

<script>
  // ====== LocalStorage keys ======
  const LS_NAMES = "tipSplit_savedNames_v2";
  const LS_PEOPLE = "tipSplit_people_v2";
  const LS_MODE  = "tipSplit_extraMode_v2";

  const $ = (id) => document.getElementById(id);

  function toNum(v){
    const n = parseFloat(String(v ?? "").replace(/[^0-9.]/g,""));
    return Number.isFinite(n) ? n : 0;
  }
  function money0(n){ return "$" + n.toFixed(0); }
  function money2(n){ return "$" + n.toFixed(2); }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ====== Saved names (autocomplete) ======
  function loadSavedNames(){
    try {
      const raw = localStorage.getItem(LS_NAMES);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }

  function saveNames(names){
    const clean = Array.from(new Set(names.map(s => String(s).trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b));
    localStorage.setItem(LS_NAMES, JSON.stringify(clean));
    renderNameDatalist(clean);
    return clean;
  }

  function addNameToSaved(name){
    const n = String(name).trim();
    if (!n) return;
    const names = loadSavedNames();
    names.push(n);
    saveNames(names);
  }

  function renderNameDatalist(names){
    const dl = $("nameSuggestions");
    dl.innerHTML = "";
    names.forEach(n=>{
      const opt = document.createElement("option");
      opt.value = n;
      dl.appendChild(opt);
    });
  }

  // ====== People list ======
  const peopleDefault = [
    { name: "John Roro", hours: 7.5 },
    { name: "Brandon", hours: 8.5 },
    { name: "Ryan", hours: 8.5 },
    { name: "Ty", hours: 7.5 },
    { name: "Matt S", hours: 15.5 },
    { name: "Will", hours: 8.5 },
    { name: "Angel", hours: 8.5 },
    { name: "Hunter", hours: 8.5 },
    { name: "Mason", hours: 8.0 },
    { name: "Matt M", hours: 8.5 },
  ];

  function loadPeople(){
    try {
      const raw = localStorage.getItem(LS_PEOPLE);
      const arr = raw ? JSON.parse(raw) : null;
      if (!Array.isArray(arr) || arr.length === 0) return peopleDefault;
      return arr.map(p => ({ name: String(p.name ?? ""), hours: toNum(p.hours) }));
    } catch {
      return peopleDefault;
    }
  }

  function savePeople(){
    localStorage.setItem(LS_PEOPLE, JSON.stringify(people));
  }

  let people = loadPeople();

  // ===== Rendering rows =====
  function renderRows(finalPays = null){
    const rows = $("rows");
    rows.innerHTML = "";

    people.forEach((p, i) => {
      const row = document.createElement("div");
      row.className = "trow";

      const nameCell = document.createElement("div");
      nameCell.className = "nameCell";

      const del = document.createElement("button");
      del.className = "miniBtn";
      del.textContent = "−";
      del.title = "Remove";
      del.onclick = () => {
        people.splice(i, 1);
        savePeople();
        renderRows(finalPays);
      };

      const nameInput = document.createElement("input");
      nameInput.value = p.name;
      nameInput.list = "nameSuggestions";
      nameInput.placeholder = "Name";
      nameInput.oninput = (e) => { people[i].name = e.target.value; savePeople(); };
      nameInput.onblur = () => { addNameToSaved(nameInput.value); };

      nameCell.appendChild(del);
      nameCell.appendChild(nameInput);

      const hoursInput = document.createElement("input");
      hoursInput.value = String(p.hours ?? "");
      hoursInput.placeholder = "Hours";
      hoursInput.inputMode = "decimal";
      hoursInput.oninput = (e) => { people[i].hours = toNum(e.target.value); savePeople(); };

      const payPill = document.createElement("div");
      payPill.className = "payPill" + (finalPays ? " ready" : "");
      payPill.textContent = finalPays ? money0(finalPays[i] || 0) : "—";

      row.appendChild(nameCell);
      row.appendChild(hoursInput);
      row.appendChild(payPill);

      rows.appendChild(row);
    });
  }

  // ===== Extra money strategies =====
  function allocateExtrasRandom(finalPay, eligibleIdxs, extras){
    if (extras <= 0) return;
    const bag = eligibleIdxs.slice();
    shuffle(bag);
    for (let k = 0; k < extras; k++){
      if (bag.length === 0) break;
      finalPay[bag[k % bag.length]] += 1;
      if ((k % bag.length) === bag.length - 1) shuffle(bag);
    }
  }

  // OLD WAY (requested):
  // Extra dollars go to whoever worked the MOST hours.
  // If there are ties for most hours, extras split evenly among them.
  // If remainder after even split, distribute remaining $1s randomly among the tied group.
  function allocateExtrasTopHoursSplit(finalPay, hoursArr, eligibleIdxs, extras){
    if (extras <= 0) return;

    let maxH = -Infinity;
    for (const i of eligibleIdxs) maxH = Math.max(maxH, hoursArr[i]);

    const top = eligibleIdxs.filter(i => hoursArr[i] === maxH);
    if (top.length === 0) return;

    const each = Math.floor(extras / top.length);
    if (each > 0){
      for (const i of top) finalPay[i] += each;
      extras -= each * top.length;
    }

    if (extras > 0){
      const picks = shuffle(top.slice()).slice(0, extras);
      for (const i of picks) finalPay[i] += 1;
    }
  }

  // ===== Calculation =====
  function calculate(){
    const totalTips = Math.round(toNum($("totalTips").value));
    const mode = $("extraMode").value;

    const hoursArr = people.map(p => toNum(p.hours));
    const sumHours = hoursArr.reduce((a,b)=>a+b,0);

    if (totalTips <= 0 || sumHours <= 0 || people.length === 0){
      $("status").innerHTML = `<span class="no">Enter total + hours</span>`;
      $("sumHours").textContent = "0";
      $("sumPay").textContent = "$0";
      $("rate").textContent = "$0.00";
      $("unassigned").textContent = "$0";
      renderRows(null);
      return;
    }

    // Grow the autocomplete list automatically
    people.forEach(p => addNameToSaved(p.name));

    const rate = totalTips / sumHours;

    // Base pay: floor(exact). NO CENTS EVER.
    const exact = hoursArr.map(h => h * rate);
    const base = exact.map(x => Math.floor(x));

    const baseSum = base.reduce((a,b)=>a+b,0);
    let extras = totalTips - baseSum; // whole dollars left over

    const finalPay = base.slice();

    // Eligible = hours > 0 AND name not blank
    const eligibleIdxs = people
      .map((p,i)=>({p,i}))
      .filter(x => toNum(x.p.hours) > 0 && String(x.p.name).trim() !== "")
      .map(x => x.i);

    if (mode === "none"){
      // do nothing: extras remain unassigned
    } else if (mode === "random"){
      allocateExtrasRandom(finalPay, eligibleIdxs, extras);
      extras = 0;
    } else if (mode === "tophours"){
      allocateExtrasTopHoursSplit(finalPay, hoursArr, eligibleIdxs, extras);
      extras = 0;
    }

    const sumPay = finalPay.reduce((a,b)=>a+b,0);

    $("sumHours").textContent = sumHours.toFixed(1).replace(/\.0$/,"");
    $("sumPay").textContent = money0(sumPay);
    $("rate").textContent = money2(rate);
    $("unassigned").textContent = money0(Math.max(0, totalTips - sumPay));

    if (sumPay === totalTips){
      $("status").innerHTML = `<span class="ok">Perfect (${money0(totalTips)})</span>`;
    } else {
      $("status").innerHTML = `<span class="no">Not fully assigned (${money0(totalTips - sumPay)} left)</span>`;
    }

    renderRows(finalPay);
  }

  // ===== Actions =====
  function addPerson(){
    const n = $("quickName").value.trim();
    const h = toNum($("quickHours").value);
    if (!n || h <= 0) return;

    people.push({ name:n, hours:h });
    addNameToSaved(n);
    savePeople();

    $("quickName").value = "";
    $("quickHours").value = "";
    renderRows(null);
    $("quickName").focus();
  }

  function resetAll(){
    if (!confirm("Reset the list? (Saved names stay)")) return;
    people = [];
    savePeople();
    $("totalTips").value = "";
    $("quickName").value = "";
    $("quickHours").value = "";
    $("sumHours").textContent = "0";
    $("sumPay").textContent = "$0";
    $("rate").textContent = "$0.00";
    $("unassigned").textContent = "$0";
    $("status").innerHTML = `<span class="no">Waiting</span>`;
    renderRows(null);
  }

  // Persist selected mode
  function loadMode(){
    const m = localStorage.getItem(LS_MODE);
    if (m) $("extraMode").value = m;
  }
  $("extraMode").addEventListener("change", () => {
    localStorage.setItem(LS_MODE, $("extraMode").value);
  });

  // Wire up
  $("calcBtn").onclick = calculate;
  $("addBtn").onclick = addPerson;
  $("resetBtn").onclick = resetAll;

  $("quickName").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); $("quickHours").focus(); }
  });
  $("quickHours").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); addPerson(); }
  });
  $("totalTips").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); calculate(); }
  });

  // Init
  renderNameDatalist(saveNames(loadSavedNames().concat(people.map(p=>p.name))));
  loadMode();
  renderRows(null);

  // PWA SW registration
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }
</script>
</body>
</html>
