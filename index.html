<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <title>Tip Split</title>

  <style>
    :root{
      --bg:#070a12;
      --line:rgba(255,255,255,.08);
      --text:#eef2ff;
      --muted:rgba(238,242,255,.68);
      --brand:#3b82f6;
      --good:#22c55e;
      --bad:#fb7185;
      --warn:#f59e0b;
      --tap:52px;
      --shadow: 0 12px 34px rgba(0,0,0,.45);
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(59,130,246,.25), transparent 55%),
        radial-gradient(900px 600px at 120% 0%, rgba(34,197,94,.16), transparent 60%),
        linear-gradient(180deg, var(--bg), #05070d 60%, #04060b);
      min-height:100vh;
      -webkit-text-size-adjust: 100%;
    }

    header{
      position:sticky; top:0; z-index:20;
      padding:14px 16px 10px;
      padding-top: calc(14px + env(safe-area-inset-top));
      background: rgba(7,10,18,.92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--line);
    }
    .titleRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }

    .wrap{
      max-width:700px; margin:0 auto; padding:12px;
      padding-bottom: calc(24px + env(safe-area-inset-bottom));
    }
    .shell{
      border:1px solid var(--line);
      background: rgba(11,15,26,.72);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .gridTop{ padding:14px; display:flex; flex-direction:column; gap:12px; }
    .gridRow2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

    label{ display:block; font-size:13px; font-weight:600; color:var(--muted); margin:0 0 6px; }

    input, select{
      width:100%; height:var(--tap); padding:0 14px;
      border-radius:14px; border:1px solid var(--line);
      background: rgba(15,21,38,.9); color:var(--text);
      outline:none; font-size:16px;
      -webkit-appearance:none; appearance:none;
      transition: border-color .15s, box-shadow .15s;
    }
    input::placeholder{ color:rgba(238,242,255,.35); }
    input:focus, select:focus{
      border-color:rgba(59,130,246,.75);
      box-shadow: 0 0 0 3px rgba(59,130,246,.18);
    }
    input.error{
      border-color:rgba(251,113,133,.75) !important;
      box-shadow: 0 0 0 3px rgba(251,113,133,.18) !important;
      animation: shake .35s ease;
    }
    @keyframes shake{
      0%,100%{ transform:translateX(0); }
      20%{ transform:translateX(-6px); }
      40%{ transform:translateX(6px); }
      60%{ transform:translateX(-4px); }
      80%{ transform:translateX(4px); }
    }
    select{
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='rgba(238,242,255,.5)' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 14px center; padding-right:36px;
    }

    .btnRow{ padding:0 14px 14px; display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btnRow .primary{ grid-column:1/-1; }

    button{
      height:var(--tap); padding:0 14px; border-radius:14px;
      border:1px solid var(--line); background:rgba(15,21,38,.9);
      color:var(--text); font-size:15px; font-weight:700; cursor:pointer;
      transition: filter .12s ease, transform .06s ease;
      -webkit-appearance:none; appearance:none; touch-action:manipulation;
    }
    button.primary{
      background:linear-gradient(180deg,rgba(59,130,246,.95),rgba(59,130,246,.7));
      border-color:rgba(59,130,246,.75); font-size:17px;
    }
    button.ghost{ background:rgba(15,21,38,.7); }
    button.danger{
      background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.22);
      color:rgba(255,225,231,.95);
    }
    button.copy-btn{
      background:rgba(34,197,94,.13); border-color:rgba(34,197,94,.25);
      color:rgba(200,255,220,.95);
    }
    button:active{ transform:scale(.97); filter:brightness(.95); }

    /* Stale pill dimming */
    .pillsStale .payPill{ opacity:.4; }

    .recalcBanner{
      display:none; margin:0 14px 10px; padding:10px 14px;
      border-radius:12px; background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.25); color:rgba(255,220,130,.9);
      font-size:13px; font-weight:600;
    }
    .recalcBanner.show{ display:block; }

    /* Table */
    .table{ border-top:1px solid var(--line); }
    .thead, .trow{
      display:grid; grid-template-columns:1fr 80px 90px 44px;
      gap:8px; padding:10px 12px; align-items:center;
    }
    .thead{
      color:var(--muted); font-size:11px; font-weight:700;
      text-transform:uppercase; letter-spacing:.5px;
      background:rgba(255,255,255,.02); border-bottom:1px solid var(--line);
    }
    .trow{ border-bottom:1px solid rgba(255,255,255,.06); }
    .trow:last-child{ border-bottom:none; }

    .nameCell{ display:flex; gap:8px; align-items:center; min-width:0; }
    .miniBtn{
      width:40px; height:40px; min-width:40px; border-radius:12px;
      border:1px solid var(--line); background:rgba(7,10,18,.6);
      color:rgba(238,242,255,.85); font-size:20px; line-height:1;
      flex:0 0 auto; touch-action:manipulation;
    }
    .trow input{ height:42px; font-size:16px; padding:0 10px; border-radius:12px; }

    .payPill{
      height:42px; border-radius:999px; border:1px solid var(--line);
      background:rgba(7,10,18,.45); display:flex; align-items:center;
      justify-content:center; font-weight:900; font-variant-numeric:tabular-nums;
      font-size:15px; transition:opacity .2s;
    }
    .payPill.ready{ border-color:rgba(34,197,94,.28); box-shadow:0 0 0 3px rgba(34,197,94,.08); }

    /* Paid checkbox */
    .paidCheck{
      width:40px; height:40px; border-radius:12px;
      border:1px solid var(--line); background:rgba(7,10,18,.6);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; flex-shrink:0; touch-action:manipulation;
      transition: background .15s, border-color .15s;
      font-size:20px; user-select:none;
    }
    .paidCheck.checked{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.45);
    }
    /* Strike through name when paid */
    .trow.paid .nameCell input{
      text-decoration: line-through;
      opacity: .45;
    }
    .trow.paid .payPill{
      opacity: .45;
    }

    /* Summary */
    .summary{
      border-top:1px solid var(--line); background:rgba(0,0,0,.12);
      padding:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .box{
      border:1px solid var(--line); background:rgba(15,21,38,.75);
      border-radius:16px; padding:12px; min-height:68px;
    }
    .box.wide{ grid-column:1/-1; }
    .box .k{ color:var(--muted); font-size:11px; font-weight:600; margin-bottom:6px; text-transform:uppercase; letter-spacing:.4px; }
    .box .v{ font-size:20px; font-weight:900; font-variant-numeric:tabular-nums; }
    .ok{ color:var(--good); font-weight:900; }
    .no{ color:var(--bad); font-weight:900; }

    /* Toast */
    .toast{
      position:fixed; bottom:calc(24px + env(safe-area-inset-bottom));
      left:50%; transform:translateX(-50%) translateY(20px);
      background:rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35);
      color:rgba(200,255,220,.98); padding:12px 22px; border-radius:999px;
      font-size:14px; font-weight:700; opacity:0; pointer-events:none;
      transition:opacity .2s, transform .2s; white-space:nowrap; z-index:500;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .foot{
      padding:12px 14px; color:var(--muted); font-size:11px;
      line-height:1.5; border-top:1px solid rgba(255,255,255,.06);
    }
    .kbd{
      display:inline-block; padding:2px 8px; border:1px solid var(--line);
      border-radius:999px; background:rgba(7,10,18,.45); color:rgba(238,242,255,.85);
    }

    /* Modals / Bottom sheets */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:flex-end; justify-content:center; z-index:999;
    }
    .modalCard{
      width:100%; max-width:600px; max-height:80vh; overflow:auto;
      border-radius:22px 22px 0 0; border:1px solid var(--line); border-bottom:none;
      background:rgba(15,21,38,.98); box-shadow:var(--shadow); padding:16px;
      padding-bottom:calc(16px + env(safe-area-inset-bottom));
    }
    .sheetHandle{
      width:40px; height:4px; border-radius:999px;
      background:rgba(255,255,255,.18); margin:0 auto 14px;
    }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; }
    .modalTitle{ margin:0; font-size:16px; font-weight:700; }
    .modalRow{
      display:flex; gap:10px; align-items:center; padding:12px;
      border:1px solid rgba(255,255,255,.06); border-radius:14px;
      margin-bottom:8px; background:rgba(7,10,18,.35);
    }
    .nameText{
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      flex:1; color:rgba(238,242,255,.92); font-weight:700; font-size:15px;
    }
    .iconBtn{
      height:42px; min-width:42px; width:42px; padding:0; border-radius:12px;
      border:1px solid rgba(255,255,255,.10); background:rgba(251,113,133,.12);
      color:rgba(255,225,231,.95); cursor:pointer; font-weight:900;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; flex-shrink:0; touch-action:manipulation;
    }
    .modalActions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px; }
    .mutedSmall{ color:var(--muted); font-size:12px; line-height:1.4; margin-bottom:10px; }

    .dangerZone{
      margin-top:12px; padding:14px;
      border:1px solid rgba(251,113,133,.22); border-radius:16px;
      background:rgba(251,113,133,.06);
    }
    .dangerZone p{ margin:0 0 10px; font-size:13px; color:rgba(255,200,210,.85); line-height:1.4; }
    .dangerZone button{ width:100%; }

    /* ‚îÄ‚îÄ Spin Wheel ‚îÄ‚îÄ */
    .wheelModal{
      position:fixed; inset:0; background:rgba(0,0,0,.8);
      display:none; align-items:center; justify-content:center;
      z-index:999; padding:16px;
    }
    .wheelCard{
      width:100%; max-width:420px;
      border-radius:24px; border:1px solid var(--line);
      background:rgba(10,14,28,.97); box-shadow:var(--shadow);
      padding:20px; display:flex; flex-direction:column; align-items:center; gap:16px;
    }
    .wheelHead{
      width:100%; display:flex; align-items:center; justify-content:space-between;
    }
    .wheelTitle{ margin:0; font-size:17px; font-weight:700; }
    .wheelWrap{
      position:relative; width:min(320px, calc(100vw - 80px));
      height:min(320px, calc(100vw - 80px));
      flex-shrink:0;
    }
    #wheelCanvas{
      width:100%; height:100%; border-radius:50%;
      box-shadow: 0 0 0 3px rgba(255,255,255,.08), 0 8px 32px rgba(0,0,0,.5);
    }
    /* Pointer triangle */
    .wheelPointer{
      position:absolute; top:-14px; left:50%; transform:translateX(-50%);
      width:0; height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-top:22px solid #f59e0b;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.5));
      z-index:2;
    }
    .wheelResult{
      min-height:52px; text-align:center;
      font-size:22px; font-weight:900; letter-spacing:.2px;
      color:var(--good);
      display:flex; align-items:center; justify-content:center;
    }
    .wheelResult.empty{ color:var(--muted); font-size:14px; font-weight:600; }
    .wheelActions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; }
    .wheelActions button{ width:100%; }
  </style>
</head>

<body>
<header>
  <div class="titleRow">
    <div>
      <h1>üíµ Tip Split</h1>
      <div style="color:var(--muted);font-size:11px;margin-top:2px;">Whole dollars only ‚Ä¢ Works offline</div>
    </div>
    <div style="color:var(--muted);font-size:11px;text-align:right;">
      Extra $: Weighted Random ‚≠ê<br/>Hours = more chances
    </div>
  </div>
</header>

<div class="wrap">
  <div class="shell">
    <div class="gridTop">
      <div>
        <label>Total Tips ($)</label>
        <input id="totalTips" inputmode="numeric" pattern="[0-9]*" placeholder="270" autocomplete="off" />
      </div>
      <div class="gridRow2">
        <div>
          <label>Name</label>
          <input id="quickName" list="nameSuggestions" placeholder="Name‚Ä¶" autocomplete="off" />
          <datalist id="nameSuggestions"></datalist>
        </div>
        <div>
          <label>Hours</label>
          <div style="display:flex; gap:8px;">
            <input id="quickHours" inputmode="decimal" placeholder="8.5" autocomplete="off" />
            <button class="ghost" id="addBtn" style="flex-shrink:0; width:52px; padding:0; font-size:22px;">Ôºã</button>
          </div>
        </div>
      </div>
      <div>
        <label>Extra Money Option</label>
        <select id="extraMode">
          <option value="none">Do nothing (show unassigned $)</option>
          <option value="random">Random (equal chance)</option>
          <option value="tophours">Top Hours (split ties)</option>
          <option value="weighted" selected>Weighted Random ‚≠ê (hours = more tickets)</option>
          <option value="wheel">üé° Spin the Wheel (spin per dollar)</option>
        </select>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="calcBtn">Calculate</button>
      <button class="ghost"   id="manageNamesBtn">Manage Names</button>
      <button class="danger"  id="resetBtn">Reset‚Ä¶</button>
    </div>

    <div class="recalcBanner" id="recalcBanner">‚ö†Ô∏è Data changed ‚Äî tap Calculate to update</div>

    <div class="table" id="tableWrap">
      <div class="thead">
        <div>Name</div>
        <div>Hours</div>
        <div>Pay</div>
        <div>‚úì</div>
      </div>
      <div id="rows"></div>
    </div>

    <div class="summary">
      <div class="box"><div class="k">Total Hours</div><div class="v" id="sumHours">0</div></div>
      <div class="box"><div class="k">Rate ($/hr)</div><div class="v" id="rate">$0.00</div></div>
      <div class="box"><div class="k">Sum of Payouts</div><div class="v" id="sumPay">$0</div></div>
      <div class="box"><div class="k">Unassigned $</div><div class="v" id="unassigned">$0</div></div>
      <div class="box wide"><div class="k">Status</div><div class="v" id="status"><span class="no">Waiting</span></div></div>
      <div class="box wide"><div class="k">Payout Progress</div><div class="v" id="paidStatus">‚Äî</div></div>
    </div>

    <div id="copyRow" style="display:none;padding:0 14px 14px;">
      <button class="copy-btn" id="copyBtn" style="width:100%;">üìã Copy Results to Clipboard</button>
    </div>

    <div class="foot">
      Type name ‚Üí tap Hours ‚Üí <span class="kbd">Ôºã Add Person</span>. Names save automatically. Max 50 people.
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Manage Names sheet -->
<div class="modal" id="namesModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="Manage Names">
    <div class="sheetHandle"></div>
    <div class="modalHead">
      <h3 class="modalTitle">Manage Saved Names</h3>
      <button class="iconBtn" id="closeNamesBtn">√ó</button>
    </div>
    <div class="mutedSmall">These names appear in autocomplete. Delete any typos to clean up.</div>
    <div id="namesList"></div>
    <div class="modalActions">
      <button class="ghost"   id="clearNamesBtn">Clear All</button>
      <button class="primary" id="doneNamesBtn">Done</button>
    </div>
  </div>
</div>

<!-- Spin Wheel Modal -->
<div class="wheelModal" id="wheelModal" aria-hidden="true">
  <div class="wheelCard" role="dialog" aria-modal="true" aria-label="Spin the Wheel">
    <div class="wheelHead">
      <h3 class="wheelTitle">üé° Spin the Wheel</h3>
      <button class="iconBtn" id="closeWheelBtn">√ó</button>
    </div>
    <div class="wheelWrap">
      <div class="wheelPointer"></div>
      <canvas id="wheelCanvas" width="600" height="600"></canvas>
    </div>
    <div class="wheelResult empty" id="wheelResult">Add people to spin!</div>
    <div class="wheelActions">
      <button class="primary" id="spinBtn">üé∞ Spin!</button>
      <button class="ghost"   id="closeWheelBtn2">Done</button>
    </div>
  </div>
</div>
<div class="modal" id="resetModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="Reset">
    <div class="sheetHandle"></div>
    <div class="modalHead">
      <h3 class="modalTitle">Reset</h3>
      <button class="iconBtn" id="closeResetBtn">√ó</button>
    </div>
    <p class="mutedSmall">Choose what to clear. Autocomplete names are always kept unless you use Manage Names.</p>
    <div class="dangerZone">
      <p>üóë <strong>Clear people list</strong> ‚Äî removes everyone from the table. Keeps your tip total &amp; autocomplete names.</p>
      <button class="danger" id="confirmResetPeopleBtn">Clear People List</button>
    </div>
    <div class="dangerZone">
      <p>üí£ <strong>Full reset</strong> ‚Äî clears people list AND the total tips amount.</p>
      <button class="danger" id="confirmResetAllBtn">Full Reset</button>
    </div>
  </div>
</div>

<script>
  const LS_NAMES  = "tipSplit_savedNames_v2";
  const LS_PEOPLE = "tipSplit_people_v2";
  const LS_MODE   = "tipSplit_extraMode_v2";
  const MAX_PEOPLE = 50;

  const $ = id => document.getElementById(id);

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toNum(v){
    const n = parseFloat(String(v ?? "").replace(/[^0-9.]/g,""));
    return Number.isFinite(n) ? n : 0;
  }
  function money0(n){ return "$" + Math.round(n); }
  function money2(n){ return "$" + n.toFixed(2); }

  // Returns a new shuffled copy ‚Äî never mutates the original
  function shuffled(arr){
    const a = arr.slice();
    for(let i = a.length-1; i > 0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _toastTimer = null;
  function showToast(msg, ms=2400){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(_toastTimer);
    _toastTimer = setTimeout(()=>t.classList.remove("show"), ms);
  }

  // ‚îÄ‚îÄ Input error shake ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function flashError(el){
    el.classList.remove("error");
    void el.offsetWidth; // force reflow to restart animation
    el.classList.add("error");
    setTimeout(()=>el.classList.remove("error"), 400);
  }

  // ‚îÄ‚îÄ Saved names ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function loadSavedNames(){
    try{
      const arr = JSON.parse(localStorage.getItem(LS_NAMES)||"[]");
      return Array.isArray(arr)?arr:[];
    }catch{return[];}
  }
  function saveNames(names){
    const clean = Array.from(new Set(names.map(s=>String(s).trim()).filter(Boolean)))
                       .sort((a,b)=>a.localeCompare(b));
    localStorage.setItem(LS_NAMES, JSON.stringify(clean));
    renderNameDatalist(clean);
    return clean;
  }
  // Only called on blur / confirmed submission ‚Äî not on every keystroke
  function addNameToSaved(name){
    const n = String(name).trim();
    if(!n) return;
    saveNames(loadSavedNames().concat(n));
  }
  function removeSavedName(name){
    saveNames(loadSavedNames().filter(x=>x!==String(name).trim()));
  }
  function clearSavedNames(){
    localStorage.setItem(LS_NAMES,"[]");
    renderNameDatalist([]);
  }
  function renderNameDatalist(names){
    const dl = $("nameSuggestions");
    dl.innerHTML = "";
    names.forEach(n=>{
      const opt = document.createElement("option");
      opt.value = n;
      dl.appendChild(opt);
    });
  }

  // ‚îÄ‚îÄ People ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function loadPeople(){
    try{
      const arr = JSON.parse(localStorage.getItem(LS_PEOPLE)||"null");
      if(!Array.isArray(arr)) return [];
      return arr.map(p=>({name:String(p.name??""),hours:toNum(p.hours),paid:!!p.paid}));
    }catch{return[];}
  }
  function savePeople(){ localStorage.setItem(LS_PEOPLE,JSON.stringify(people)); }

  let people = loadPeople();

  // ‚îÄ‚îÄ Dirty / stale state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let calculated     = false;
  let _lastFinalPay  = null;
  let _lastTotalTips = 0;

  function markDirty(){
    if(!calculated) return;
    $("tableWrap").classList.add("pillsStale");
    $("recalcBanner").classList.add("show");
  }
  function markClean(){
    $("tableWrap").classList.remove("pillsStale");
    $("recalcBanner").classList.remove("show");
  }

  // ‚îÄ‚îÄ Render rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderRows(finalPays=null){
    const container = $("rows");
    container.innerHTML = "";
    people.forEach((p,i)=>{
      const row = document.createElement("div");
      row.className = "trow";

      // Name cell
      const nameCell = document.createElement("div");
      nameCell.className = "nameCell";

      const del = document.createElement("button");
      del.className = "miniBtn";
      del.textContent = "‚àí";
      del.addEventListener("click",()=>{
        people.splice(i,1);
        savePeople();
        markDirty();
        renderRows(finalPays);
      });

      const nameInput = document.createElement("input");
      nameInput.value = p.name;
      nameInput.setAttribute("list","nameSuggestions");
      nameInput.placeholder = "Name";
      nameInput.autocomplete = "off";
      nameInput.addEventListener("input",e=>{
        people[i].name = e.target.value;
        savePeople();
        markDirty();
        // No addNameToSaved here ‚Äî wait for blur so partial names don't get saved
      });
      nameInput.addEventListener("blur",()=>{
        if(people[i]?.name.trim()) addNameToSaved(people[i].name);
      });

      nameCell.appendChild(del);
      nameCell.appendChild(nameInput);

      const hoursInput = document.createElement("input");
      hoursInput.value = String(p.hours||"");
      hoursInput.placeholder = "Hrs";
      hoursInput.inputMode = "decimal";
      hoursInput.autocomplete = "off";
      hoursInput.addEventListener("input",e=>{
        people[i].hours = toNum(e.target.value);
        savePeople();
        markDirty();
      });

      const payPill = document.createElement("div");
      payPill.className = "payPill"+(finalPays?" ready":"");
      payPill.textContent = finalPays ? money0(finalPays[i]??0) : "‚Äî";

      // Paid checkbox
      const paidBtn = document.createElement("div");
      paidBtn.className = "paidCheck"+(p.paid?" checked":"");
      paidBtn.title = p.paid ? "Mark unpaid" : "Mark paid";
      paidBtn.textContent = p.paid ? "‚úì" : "";
      paidBtn.addEventListener("click",()=>{
        people[i].paid = !people[i].paid;
        savePeople();
        renderRows(finalPays);
      });

      if(p.paid) row.classList.add("paid");

      row.appendChild(nameCell);
      row.appendChild(hoursInput);
      row.appendChild(payPill);
      row.appendChild(paidBtn);
      container.appendChild(row);
    });

    // Update paid progress
    const paidCount = people.filter(p=>p.paid).length;
    const total = people.length;
    const ps = $("paidStatus");
    if(total===0){
      ps.innerHTML = "‚Äî";
    }else if(paidCount===total){
      ps.innerHTML = `<span class="ok">‚úì All ${total} paid out!</span>`;
    }else{
      ps.innerHTML = `<span style="color:var(--warn)">${paidCount} / ${total} paid out</span>`;
    }
  }

  // ‚îÄ‚îÄ Extra money strategies ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Both return the dollar amount actually distributed.

  function allocateRandom(finalPay, eligibleIdxs, extras){
    if(extras<=0||eligibleIdxs.length===0) return 0;
    const bag = shuffled(eligibleIdxs);
    for(let k=0;k<extras;k++) finalPay[bag[k%bag.length]]+=1;
    return extras;
  }

  // Weighted random: each eligible person gets "tickets" proportional to their hours.
  // Each leftover $1 is awarded independently via a weighted draw (with replacement reset each round).
  function allocateWeightedRandom(finalPay, hoursArr, eligibleIdxs, extras){
    if(extras<=0||eligibleIdxs.length===0) return 0;
    // Build a weighted ticket pool ‚Äî scale to integers by multiplying hours * 2 (handles .5 increments)
    const tickets = [];
    for(const i of eligibleIdxs){
      const count = Math.round(hoursArr[i] * 2); // e.g. 8.5hrs ‚Üí 17 tickets
      for(let t=0;t<count;t++) tickets.push(i);
    }
    // Award each extra dollar via an independent weighted draw
    for(let k=0;k<extras;k++){
      const winner = tickets[Math.floor(Math.random()*tickets.length)];
      finalPay[winner]+=1;
    }
    return extras;
  }

  function allocateTopHours(finalPay, hoursArr, eligibleIdxs, extras){
    if(extras<=0||eligibleIdxs.length===0) return 0;
    const maxH = Math.max(...eligibleIdxs.map(i=>hoursArr[i]));
    const top  = eligibleIdxs.filter(i=>hoursArr[i]===maxH);
    let dist = 0;
    const each = Math.floor(extras/top.length);
    if(each>0){ for(const i of top){ finalPay[i]+=each; dist+=each; } }
    const leftover = extras-dist;
    if(leftover>0){
      const picks = shuffled(top).slice(0,leftover);
      for(const i of picks){ finalPay[i]+=1; dist+=1; }
    }
    return dist;
  }

  // ‚îÄ‚îÄ Calculate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calculate(){
    const totalTips = Math.round(toNum($("totalTips").value));
    const mode = $("extraMode").value;
    const hoursArr = people.map(p=>toNum(p.hours));
    const sumHours = hoursArr.reduce((a,b)=>a+b,0);

    if(totalTips<=0||sumHours<=0||people.length===0){
      $("status").innerHTML=`<span class="no">Enter total tips &amp; at least one person with hours</span>`;
      $("sumHours").textContent="0"; $("sumPay").textContent="$0";
      $("rate").textContent="$0.00"; $("unassigned").textContent="$0";
      $("copyRow").style.display="none";
      calculated=false; _lastFinalPay=null;
      markClean(); renderRows(null); return;
    }

    const rate    = totalTips/sumHours;
    const base    = hoursArr.map(h=>Math.floor(h*rate));
    const baseSum = base.reduce((a,b)=>a+b,0);
    const extras  = totalTips-baseSum; // whole leftover dollars

    const finalPay = base.slice();

    const eligibleIdxs = people
      .map((p,i)=>({p,i}))
      .filter(x=>toNum(x.p.hours)>0&&x.p.name.trim()!=="")
      .map(x=>x.i);

    if(mode==="random")        allocateRandom(finalPay,eligibleIdxs,extras);
    else if(mode==="tophours") allocateTopHours(finalPay,hoursArr,eligibleIdxs,extras);
    else if(mode==="weighted") allocateWeightedRandom(finalPay,hoursArr,eligibleIdxs,extras);
    else if(mode==="wheel"){
      // Don't auto-assign ‚Äî open the wheel so user spins for each leftover dollar
      if(extras > 0){
        const sumPayBase = finalPay.reduce((a,b)=>a+b,0);
        calculated=true; _lastFinalPay=finalPay.slice(); _lastTotalTips=totalTips;
        markClean(); renderRows(finalPay);
        $("copyRow").style.display="block";
        $("sumHours").textContent = sumHours.toFixed(1).replace(/\.0$/,"");
        $("sumPay").textContent   = money0(sumPayBase);
        $("rate").textContent     = money2(rate);
        $("unassigned").textContent = money0(extras);
        $("status").innerHTML = `<span style="color:var(--warn)">üé° ${extras} dollar${extras>1?"s":""} to assign ‚Äî spin the wheel!</span>`;
        people.forEach(p=>{ if(p.name.trim()) addNameToSaved(p.name); });
        openWheelForExtras(finalPay, eligibleIdxs, extras, totalTips);
        return;
      }
      // extras === 0, nothing to spin for ‚Äî fall through to normal completion
    }
    // "none": extras stay unallocated, reflected in unassigned box

    const sumPay    = finalPay.reduce((a,b)=>a+b,0);
    const remaining = totalTips-sumPay;

    $("sumHours").textContent = sumHours.toFixed(1).replace(/\.0$/,"");
    $("sumPay").textContent   = money0(sumPay);
    $("rate").textContent     = money2(rate);
    $("unassigned").textContent = money0(Math.max(0,remaining));

    if(remaining===0){
      $("status").innerHTML=`<span class="ok">‚úì Perfect ‚Äî ${money0(totalTips)} fully assigned</span>`;
    }else{
      $("status").innerHTML=`<span class="no">${money0(remaining)} unassigned ‚Äî use Top Hours or Random to assign it</span>`;
    }

    // Save names to autocomplete only on confirmed calculate
    people.forEach(p=>{ if(p.name.trim()) addNameToSaved(p.name); });

    calculated=true; _lastFinalPay=finalPay.slice(); _lastTotalTips=totalTips;
    markClean(); renderRows(finalPay);
    $("copyRow").style.display="block";
  }

  // ‚îÄ‚îÄ Copy results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function copyResults(){
    if(!calculated||!_lastFinalPay){ showToast("Calculate first!"); return; }
    const lines = people.map((p,i)=>{
      const name = p.name.trim()||`Person ${i+1}`;
      return `${name}: ${money0(_lastFinalPay[i]??0)} (${toNum(p.hours)} hrs)`;
    });
    lines.push("","Total: "+money0(_lastFinalPay.reduce((a,b)=>a+b,0)));
    const text = lines.join("\n");

    if(navigator.clipboard?.writeText){
      navigator.clipboard.writeText(text)
        .then(()=>showToast("‚úì Copied to clipboard!"))
        .catch(()=>fallbackCopy(text));
    }else{ fallbackCopy(text); }
  }
  function fallbackCopy(text){
    const ta = document.createElement("textarea");
    ta.value=text; ta.style.cssText="position:fixed;opacity:0;top:0;left:0;";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try{ document.execCommand("copy"); showToast("‚úì Copied!"); }
    catch{ showToast("Couldn't copy ‚Äî try manually"); }
    document.body.removeChild(ta);
  }

  // ‚îÄ‚îÄ Add person ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addPerson(){
    const nameEl  = $("quickName");
    const hoursEl = $("quickHours");
    const n = nameEl.value.trim();
    const h = toNum(hoursEl.value);
    let valid = true;
    if(!n){ flashError(nameEl); valid=false; }
    if(h<=0){ flashError(hoursEl); valid=false; }
    if(!valid){ showToast("Enter a name and hours first"); return; }
    if(people.length>=MAX_PEOPLE){ showToast(`Max ${MAX_PEOPLE} people reached`); return; }

    people.push({name:n, hours:h, paid:false});
    addNameToSaved(n);
    savePeople();
    markDirty();
    nameEl.value=""; hoursEl.value="";
    renderRows(_lastFinalPay);
    nameEl.focus();
  }

  // ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openModal(id){ const m=$(id); m.style.display="flex"; m.setAttribute("aria-hidden","false"); }
  function closeModal(id){ const m=$(id); m.style.display="none"; m.setAttribute("aria-hidden","true"); }

  ["namesModal","resetModal","wheelModal"].forEach(id=>{
    $(id).addEventListener("click",e=>{ if(e.target.id===id) closeModal(id); });
  });
  window.addEventListener("keydown",e=>{ if(e.key==="Escape"){ closeModal("namesModal"); closeModal("resetModal"); closeModal("wheelModal"); } });

  // Manage Names
  function openNamesModal(){
    const list = $("namesList");
    const names = loadSavedNames();
    list.innerHTML="";
    if(names.length===0){
      const empty=document.createElement("div"); empty.className="mutedSmall";
      empty.textContent="No saved names yet. Add a person and it saves automatically.";
      list.appendChild(empty);
    }else{
      names.forEach(name=>{
        const row=document.createElement("div"); row.className="modalRow";
        const left=document.createElement("div"); left.className="nameText"; left.textContent=name;
        const del=document.createElement("button"); del.className="iconBtn"; del.textContent="üóë";
        del.addEventListener("click",()=>{ removeSavedName(name); openNamesModal(); });
        row.appendChild(left); row.appendChild(del); list.appendChild(row);
      });
    }
    openModal("namesModal");
  }
  $("manageNamesBtn").onclick = openNamesModal;
  $("closeNamesBtn").onclick  = ()=>closeModal("namesModal");
  $("doneNamesBtn").onclick   = ()=>closeModal("namesModal");
  $("clearNamesBtn").onclick  = ()=>{
    if(confirm("Clear ALL saved names from autocomplete?")){ clearSavedNames(); openNamesModal(); }
  };

  // Reset
  $("resetBtn").onclick      = ()=>openModal("resetModal");
  $("closeResetBtn").onclick = ()=>closeModal("resetModal");

  function doReset(clearTips){
    people=[]; savePeople(); calculated=false; _lastFinalPay=null;
    markClean();
    if(clearTips) $("totalTips").value="";
    $("copyRow").style.display="none";
    $("sumHours").textContent="0"; $("sumPay").textContent="$0";
    $("rate").textContent="$0.00"; $("unassigned").textContent="$0";
    $("status").innerHTML=`<span class="no">Waiting</span>`;
    renderRows(null); closeModal("resetModal");
    showToast(clearTips?"Full reset done":"People list cleared");
  }
  $("confirmResetPeopleBtn").onclick = ()=>doReset(false);
  $("confirmResetAllBtn").onclick    = ()=>doReset(true);

  // Extra mode persistence
  function loadMode(){ const m=localStorage.getItem(LS_MODE); if(m) $("extraMode").value=m; }
  $("extraMode").addEventListener("change",()=>{ localStorage.setItem(LS_MODE,$("extraMode").value); markDirty(); });

  // Buttons
  $("calcBtn").onclick = calculate;
  $("addBtn").onclick  = addPerson;
  $("copyBtn").onclick = copyResults;

  // Keyboard
  $("quickName").addEventListener("keydown",  e=>{ if(e.key==="Enter"){ e.preventDefault(); $("quickHours").focus(); } });
  $("quickHours").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); addPerson(); } });
  $("totalTips").addEventListener("keydown",  e=>{ if(e.key==="Enter"){ e.preventDefault(); calculate(); } });

  // ‚îÄ‚îÄ Spin Wheel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const WHEEL_COLORS = [
    "#3b82f6","#22c55e","#f59e0b","#ec4899","#8b5cf6",
    "#06b6d4","#f97316","#84cc16","#e11d48","#0ea5e9",
    "#a78bfa","#34d399","#fbbf24","#f472b6","#60a5fa",
  ];

  let wheelSpinning = false;
  let wheelAngle = 0; // current rotation in radians

  function getWheelEntries(){
    // Use current people list. Each person gets weight by hours (min 1 slice).
    if(people.length === 0) return [];
    return people.map((p,i)=>({
      label: p.name.trim() || `Person ${i+1}`,
      weight: Math.max(toNum(p.hours), 0.5),
      color: WHEEL_COLORS[i % WHEEL_COLORS.length],
    }));
  }

  function drawWheel(angle){
    const canvas = $("wheelCanvas");
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const cx = W/2, cy = H/2, r = W/2 - 4;
    const entries = getWheelEntries();

    ctx.clearRect(0,0,W,H);

    if(entries.length === 0){
      ctx.fillStyle = "rgba(255,255,255,.08)";
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = "rgba(238,242,255,.4)";
      ctx.font = "bold 28px -apple-system, system-ui, sans-serif";
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillText("No people yet", cx, cy);
      return;
    }

    const totalWeight = entries.reduce((a,e)=>a+e.weight, 0);
    let startAngle = angle;

    entries.forEach((entry, i)=>{
      const sliceAngle = (entry.weight / totalWeight) * Math.PI * 2;
      const endAngle = startAngle + sliceAngle;

      // Slice fill
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r, startAngle, endAngle);
      ctx.closePath();
      ctx.fillStyle = entry.color;
      ctx.fill();

      // Subtle border between slices
      ctx.strokeStyle = "rgba(0,0,0,.35)";
      ctx.lineWidth = 2;
      ctx.stroke();

      // Label
      const midAngle = startAngle + sliceAngle / 2;
      const labelR = r * 0.65;
      const lx = cx + Math.cos(midAngle) * labelR;
      const ly = cy + Math.sin(midAngle) * labelR;

      ctx.save();
      ctx.translate(lx, ly);
      ctx.rotate(midAngle + Math.PI/2);

      // Font size scales down for many slices
      const fs = Math.max(11, Math.min(22, Math.floor(260 / entries.length)));
      ctx.font = `bold ${fs}px -apple-system, system-ui, sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      // Shadow for readability
      ctx.shadowColor = "rgba(0,0,0,.7)";
      ctx.shadowBlur = 4;
      ctx.fillStyle = "#fff";

      // Truncate long names
      let label = entry.label;
      if(ctx.measureText(label).width > r*0.55) {
        while(label.length > 3 && ctx.measureText(label+"‚Ä¶").width > r*0.55)
          label = label.slice(0,-1);
        label += "‚Ä¶";
      }
      ctx.fillText(label, 0, 0);
      ctx.restore();

      startAngle = endAngle;
    });

    // Center cap
    ctx.beginPath();
    ctx.arc(cx, cy, 22, 0, Math.PI*2);
    ctx.fillStyle = "rgba(10,14,28,.9)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,.15)";
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function getWinnerAtAngle(angle){
    const entries = getWheelEntries();
    if(entries.length === 0) return null;
    const totalWeight = entries.reduce((a,e)=>a+e.weight,0);

    // Pointer is at the top (270deg = -PI/2).
    // We find which slice is at that position given current angle.
    let ptr = ((-angle % (Math.PI*2)) + Math.PI*2) % (Math.PI*2);
    // Offset by 270deg since wheel starts drawing at angle offset
    ptr = (ptr + Math.PI*1.5) % (Math.PI*2);

    let cumulative = 0;
    for(const entry of entries){
      cumulative += (entry.weight/totalWeight)*Math.PI*2;
      if(ptr < cumulative) return entry.label;
    }
    return entries[entries.length-1].label;
  }

  function spinWheel(){
    if(wheelSpinning) return;
    const entries = getWheelEntries();
    if(entries.length === 0){ showToast("Add people first!"); return; }

    $("wheelResult").className = "wheelResult empty";
    $("wheelResult").textContent = "Spinning‚Ä¶";
    $("spinBtn").disabled = true;
    wheelSpinning = true;

    // Random spin: 5‚Äì10 full rotations + random landing
    const extraSpins = (5 + Math.random()*5) * Math.PI*2;
    const landingOffset = Math.random() * Math.PI*2;
    const targetAngle = wheelAngle + extraSpins + landingOffset;

    const duration = 4000 + Math.random()*1500; // 4‚Äì5.5s
    const startAngle = wheelAngle;
    const startTime = performance.now();

    function easeOut(t){ return 1 - Math.pow(1-t, 4); } // quartic ease-out

    function frame(now){
      const elapsed = now - startTime;
      const t = Math.min(elapsed/duration, 1);
      wheelAngle = startAngle + (targetAngle - startAngle) * easeOut(t);
      drawWheel(wheelAngle);

      if(t < 1){
        requestAnimationFrame(frame);
      } else {
        wheelAngle = targetAngle;
        wheelSpinning = false;
        $("spinBtn").disabled = false;

      const winner = getWinnerAtAngle(wheelAngle);
        const resultEl = $("wheelResult");

        // If we're in extras-assign mode, award $1 to the winner
        if(_wheelExtrasState && _wheelExtrasState.remaining > 0){
          // Find matching person index
          const winnerIdx = people.findIndex((p,i)=>{
            const label = p.name.trim()||`Person ${i+1}`;
            return label === winner && _wheelExtrasState.eligibleIdxs.includes(i);
          });
          if(winnerIdx !== -1){
            _wheelExtrasState.finalPay[winnerIdx] += 1;
            _wheelExtrasState.remaining -= 1;
            // Update the live table so they see pay climbing
            renderRows(_wheelExtrasState.finalPay);
            $("unassigned").textContent = money0(_wheelExtrasState.remaining);
          }
          resultEl.className = "wheelResult";
          resultEl.textContent = `üéâ ${winner} gets $1!`;
          showToast(`üéâ ${winner} gets $1!`, 2000);
          setTimeout(()=>updateWheelExtrasUI(), 1200);
        } else {
          // Normal freeplay spin
          resultEl.className = "wheelResult";
          resultEl.textContent = `üéâ ${winner}!`;
          showToast(`üéâ ${winner} wins!`, 3000);
        }
      }
    }

    requestAnimationFrame(frame);
  }

  // ‚îÄ‚îÄ Wheel in "assign extras" mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Called from calculate() when mode===wheel and extras > 0.
  // Tracks remaining dollars and awards them one spin at a time.
  let _wheelExtrasState = null; // { finalPay, eligibleIdxs, remaining, totalTips }

  function openWheelForExtras(finalPay, eligibleIdxs, extras, totalTips){
    _wheelExtrasState = {
      finalPay: finalPay.slice(),
      eligibleIdxs,
      remaining: extras,
      totalTips,
    };
    openModal("wheelModal");
    updateWheelExtrasUI();
    drawWheel(wheelAngle);
  }

  function updateWheelExtrasUI(){
    const s = _wheelExtrasState;
    if(!s){ return; }
    const resultEl = $("wheelResult");
    if(s.remaining > 0){
      resultEl.className = "wheelResult empty";
      resultEl.textContent = `${s.remaining} dollar${s.remaining>1?"s":""} left to spin for!`;
      $("spinBtn").textContent = `üé∞ Spin for $1!`;
    } else {
      resultEl.className = "wheelResult";
      resultEl.textContent = "üéâ All dollars assigned!";
      $("spinBtn").textContent = "üé∞ Spin!";
      $("spinBtn").disabled = false;
      // Commit final pay back
      _lastFinalPay = s.finalPay.slice();
      renderRows(s.finalPay);
      const sumPay = s.finalPay.reduce((a,b)=>a+b,0);
      $("sumPay").textContent = money0(sumPay);
      $("unassigned").textContent = "$0";
      $("status").innerHTML = `<span class="ok">‚úì Perfect ‚Äî ${money0(s.totalTips)} fully assigned</span>`;
      $("copyRow").style.display = "block";
      _wheelExtrasState = null;
    }
  }

  function openWheelModal(){
    openModal("wheelModal");
    $("wheelResult").className = "wheelResult empty";
    $("wheelResult").textContent = people.length===0 ? "Add people to spin!" : "Tap Spin!";
    drawWheel(wheelAngle);
  }

  $("spinBtn").onclick       = spinWheel;
  $("calcBtn").onclick       = calculate;
  $("addBtn").onclick        = addPerson;
  $("closeWheelBtn").onclick = ()=>{ _wheelExtrasState=null; closeModal("wheelModal"); };
  $("closeWheelBtn2").onclick= ()=>{ _wheelExtrasState=null; closeModal("wheelModal"); };
  $("wheelModal").addEventListener("click", e=>{ if(e.target.id==="wheelModal"){ _wheelExtrasState=null; closeModal("wheelModal"); } });

  // Re-draw wheel if it's open when people change
  const _origRenderRows = renderRows;

  // Also update Escape key handler to include wheel
  window.removeEventListener("keydown", window._escHandler);
  window._escHandler = e=>{
    if(e.key==="Escape"){
      closeModal("namesModal"); closeModal("resetModal"); closeModal("wheelModal");
    }
  };
  window.addEventListener("keydown", window._escHandler);
  loadMode();
  renderRows(null);

  if("serviceWorker" in navigator){
    window.addEventListener("load",()=>navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }
</script>
</body>
</html>
